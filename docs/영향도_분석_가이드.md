# 영향도 분석 가이드

**작성일**: 2025년 1월  
**버전**: 1.0.0

> 특정 테이블 또는 컬럼에 이슈가 발생했을 때 영향받는 쿼리를 분석하는 기능입니다.

---

## 목차

1. [개요](#개요)
2. [사용 방법](#사용-방법)
3. [시나리오별 예시](#시나리오별-예시)
4. [결과 해석](#결과-해석)
5. [문제 해결](#문제-해결)

---

## 개요

### 영향도 분석이란?

영향도 분석은 특정 테이블 또는 컬럼에 문제가 발생했을 때, 해당 테이블/컬럼을 사용하는 모든 쿼리, 뷰, 함수 등을 찾아내어 영향받는 범위를 분석하는 기능입니다.

### 사용 시나리오

- **테이블 스키마 변경**: 테이블 구조 변경 시 영향받는 쿼리 확인
- **데이터 이슈 발생**: 특정 테이블의 데이터 문제 발생 시 관련 쿼리 찾기
- **컬럼 삭제/수정**: 컬럼 삭제 또는 수정 시 영향도 평가
- **성능 최적화**: 특정 테이블의 성능 개선 시 영향받는 쿼리 확인

### 분석 항목

- **직접 영향**: 해당 테이블/컬럼을 직접 사용하는 쿼리
- **간접 영향**: 관련 테이블을 통해 간접적으로 영향받는 쿼리
- **CTE 의존성**: CTE에서 사용하는 경우
- **서브쿼리 의존성**: 서브쿼리에서 사용하는 경우
- **JOIN 관계**: JOIN을 통해 연결된 테이블들

---

## 사용 방법

### 웹 인터페이스 사용

1. **SQL 쿼리 분석 실행**
   - SQL 쿼리 분석 섹션에서 쿼리 분석 실행
   - 분석이 완료되면 리니지 정보가 표시됨

2. **영향도 분석 섹션 찾기**
   - 분석 결과 화면에서 "영향도 분석" 섹션 확인
   - 리니지 정보가 있는 경우에만 표시됨

3. **분석 대상 선택**
   - **테이블 선택**: 드롭다운에서 분석할 테이블 선택
   - **컬럼 입력** (선택사항): 특정 컬럼을 분석하려면 컬럼명 입력

4. **영향도 분석 실행**
   - "영향도 분석하기" 버튼 클릭
   - 분석 결과가 자동으로 표시됨

### 리니지 시각화에서 사용

1. **리니지 시각화 열기**
   - 분석 결과에서 "🌐 리니지 시각화 보기" 버튼 클릭

2. **노드 클릭**
   - 그래프에서 분석하고 싶은 테이블 노드를 클릭
   - 자동으로 영향도 분석이 실행됨
   - 영향도 분석 섹션으로 자동 스크롤

### Python으로 직접 실행

```bash
# 기본 사용법
python test-sql-query-analyzer.py --impact <SQL 파일> <테이블명> [컬럼명]

# 예시 1: 테이블 분석
python test-sql-query-analyzer.py --impact queries/complex_query_500.sql users

# 예시 2: 컬럼 분석
python test-sql-query-analyzer.py --impact queries/complex_query_500.sql users email
```

### API로 직접 호출

```bash
curl -X POST http://localhost:3001/api/sql/impact-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "query_file": "queries/complex_query_500.sql",
    "target_table": "users",
    "target_column": "email"
  }'
```

---

## 시나리오별 예시

### 시나리오 1: 테이블 스키마 변경

**상황**: `users` 테이블의 스키마를 변경하려고 합니다.

**사용 방법**:
1. SQL 쿼리 분석 실행
2. 영향도 분석 섹션에서 테이블 "users" 선택
3. "영향도 분석하기" 버튼 클릭

**결과 예시**:
```
영향도 수준: HIGH
영향도 점수: 80/100
직접 영향: 6개
간접 영향: 0개
영향받는 테이블: news, apiKeys, radioSongs
영향받는 CTE: user_news_stats, user_radio_stats
```

**권장사항**:
- 변경 전 모든 영향받는 쿼리 검토 필요
- 단계별로 변경 진행 권장

### 시나리오 2: 컬럼 삭제

**상황**: `users` 테이블의 `email` 컬럼을 삭제하려고 합니다.

**사용 방법**:
1. SQL 쿼리 분석 실행
2. 영향도 분석 섹션에서 테이블 "users", 컬럼 "email" 입력
3. "영향도 분석하기" 버튼 클릭

**결과 예시**:
```
영향도 수준: CRITICAL
영향도 점수: 100/100
직접 영향: 5개 (SELECT 절에서 사용)
간접 영향: 3개 (WHERE 절에서 사용)
영향받는 CTE: user_news_stats
```

**권장사항**:
- 컬럼 삭제 시 쿼리 결과에 영향을 미침
- 대체 컬럼 사용 또는 쿼리 수정 필요

### 시나리오 3: 데이터 이슈 발생

**상황**: `news` 테이블에 데이터 문제가 발생했습니다.

**사용 방법**:
1. SQL 쿼리 분석 실행
2. 리니지 시각화에서 "news" 노드 클릭
3. 자동으로 영향도 분석 실행

**결과 예시**:
```
영향도 수준: MEDIUM
영향도 점수: 50/100
직접 영향: 3개
간접 영향: 2개
영향받는 테이블: users
```

---

## 결과 해석

### 영향도 수준

- **CRITICAL**: 즉시 조치 필요. SELECT 절에서 직접 사용되는 경우
- **HIGH**: 주요 쿼리 검토 필요. WHERE/JOIN 절에서 직접 사용되는 경우
- **MEDIUM**: 검토 권장. GROUP BY/ORDER BY에서 사용되거나 JOIN 관계
- **LOW**: 참고사항. CTE/서브쿼리에서 간접 사용되는 경우

### 영향도 점수

- **90-100**: CRITICAL - 즉시 조치 필요
- **70-89**: HIGH - 주요 쿼리 검토 필요
- **50-69**: MEDIUM - 검토 권장
- **0-49**: LOW - 참고사항

### 직접 영향 vs 간접 영향

- **직접 영향**: 해당 테이블/컬럼을 직접 사용하는 쿼리
  - FROM 절에서 사용
  - JOIN 절에서 사용
  - SELECT 절에서 컬럼 사용
  - WHERE 절에서 컬럼 사용

- **간접 영향**: 관련 테이블을 통해 간접적으로 영향받는 쿼리
  - JOIN 관계를 통한 전파
  - CTE 의존성을 통한 전파
  - 서브쿼리 관계를 통한 전파

---

## 문제 해결

### 영향도 분석이 실행되지 않음

**원인**: SQL 쿼리 분석이 먼저 실행되어야 합니다.

**해결 방법**:
1. SQL 쿼리 분석을 먼저 실행
2. 분석 결과에 리니지 정보가 있는지 확인
3. 리니지 정보가 있으면 영향도 분석 섹션이 표시됨

### 테이블이 드롭다운에 표시되지 않음

**원인**: 해당 테이블이 쿼리에 사용되지 않았거나 파싱 오류

**해결 방법**:
1. SQL 쿼리에서 테이블명이 정확한지 확인
2. 테이블명에 특수문자나 공백이 있는지 확인
3. 쿼리 문법 오류 확인

### 영향도 분석 결과가 부정확함

**원인**: 정적 분석의 한계로 인한 추정 오류

**해결 방법**:
1. 실제 데이터베이스에서 쿼리 실행하여 검증
2. EXPLAIN ANALYZE 결과와 비교
3. 수동으로 쿼리 검토

---

## 고급 사용법

### 여러 테이블 동시 분석

현재는 한 번에 하나의 테이블만 분석할 수 있습니다. 여러 테이블을 분석하려면 각각 실행하세요.

### 컬럼별 상세 분석

특정 컬럼을 지정하면 해당 컬럼이 사용되는 위치를 정확히 찾을 수 있습니다.

### 리니지 시각화 연동

리니지 시각화에서 노드를 클릭하면 자동으로 영향도 분석이 실행되어 편리합니다.

---

## 제한사항

1. **정적 분석**: 실제 실행 계획 없이 쿼리 텍스트만 분석
2. **파싱 한계**: 복잡한 쿼리나 동적 쿼리는 정확도가 떨어질 수 있음
3. **데이터베이스 독립적**: 실제 데이터베이스 스키마 정보 없이 분석

---

## 향후 개선 계획

1. **동적 분석 통합**: PostgreSQL EXPLAIN ANALYZE 결과 통합
2. **다중 테이블 분석**: 여러 테이블을 동시에 분석
3. **실제 스키마 연동**: 데이터베이스 스키마 정보 활용
4. **자동 수정 제안**: 영향받는 쿼리 자동 수정 제안

---

**마지막 업데이트**: 2025년 1월

