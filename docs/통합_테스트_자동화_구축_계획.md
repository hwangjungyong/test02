# Playwright 기반 통합 테스트 자동화 구축 계획

**작성일**: 2025년 1월  
**목적**: 배포 전 화면 검증 및 회귀 테스트 자동화 시스템 구축  
**예상 MM**: 0.5 MM

---

## 1. 개요

### 1.1 목표

Playwright를 활용한 통합 테스트 자동화 시스템을 구축하여 배포 전 화면 검증 시간을 85% 단축하고, UI 버그를 사전에 발견하여 배포 후 장애를 예방합니다.

### 1.2 핵심 기능

- 주요 화면 자동 검증 (10개 이상 화면)
- 스크린샷 기반 회귀 테스트
- 요소 값 자동 검증
- 배포 전 자동 테스트 실행
- 테스트 결과 리포트 자동 생성

---

## 2. 현재 상태 분석

### 2.1 기존 구현 현황

**현재 파일**: `mcp-screen-validator-server.py`

**기능**:
- ✅ 웹 페이지 화면 캡처 (`capture_screen`)
- ✅ 요소 값 읽기 (`read_element_value`)
- ✅ 화면 요소 검증 (`validate_screen_element`)

**제한사항**:
- ❌ 테스트 케이스 관리 기능 없음
- ❌ 스크린샷 비교 기능 없음
- ❌ 배치 테스트 실행 기능 없음
- ❌ 테스트 결과 리포트 기능 없음

### 2.2 개선 필요 사항

1. **테스트 케이스 관리**: YAML/JSON 기반 테스트 케이스 정의 및 관리
2. **회귀 테스트**: 기준 스크린샷과 비교하여 변경사항 감지
3. **배치 실행**: 여러 화면을 한 번에 테스트
4. **리포트 생성**: 테스트 결과를 마크다운/HTML로 자동 생성

---

## 3. 구축 계획

### 3.1 아키텍처 설계

```
┌─────────────────────────────────────────┐
│  MCP 통합 테스트 자동화 서버              │
│  (mcp-integration-test-server.py)      │
└─────────────────────────────────────────┘
           │
           ├─── 테스트 케이스 관리
           │    └─── YAML/JSON 파싱
           │
           ├─── Playwright 실행 엔진
           │    └─── 브라우저 자동화
           │
           ├─── 스크린샷 비교 엔진
           │    └─── 이미지 차이 분석
           │
           └─── 리포트 생성기
                └─── 마크다운/HTML 생성
```

### 3.2 기술 스택

- **언어**: Python 3.8+
- **프레임워크**: Playwright (Python)
- **이미지 비교**: Pillow (PIL), OpenCV (선택사항)
- **테스트 케이스**: YAML 또는 JSON
- **리포트**: Jinja2 템플릿 엔진

### 3.3 파일 구조

```
test02/
├── mcp-integration-test-server.py      # 메인 MCP 서버
├── tests/                               # 테스트 케이스 디렉토리
│   ├── test-cases.yaml                 # 테스트 케이스 정의
│   └── screenshots/                    # 기준 스크린샷 저장
│       ├── baseline/                   # 기준 이미지
│       └── current/                    # 현재 실행 이미지
├── test-results/                       # 테스트 결과 저장
│   ├── reports/                        # 리포트 파일
│   └── screenshots/                    # 실행 스크린샷
└── test-utils/                         # 테스트 유틸리티
    ├── screenshot_comparer.py          # 스크린샷 비교 모듈
    ├── test_runner.py                  # 테스트 실행 모듈
    └── report_generator.py             # 리포트 생성 모듈
```

---

## 4. 단계별 구현 계획

### Phase 1: 테스트 케이스 관리 시스템 (1주)

**목표**: YAML 기반 테스트 케이스 정의 및 파싱 기능 구현

**작업 내용**:
1. 테스트 케이스 YAML 스키마 설계
2. YAML 파서 구현
3. 테스트 케이스 검증 로직 구현
4. 테스트 케이스 CRUD 기능 구현

**예상 산출물**:
- `tests/test-cases.yaml` (예시 파일)
- `test-utils/test_case_parser.py`

**테스트 케이스 예시**:
```yaml
test_suites:
  - name: "메인 화면 검증"
    description: "홈페이지 주요 화면 검증"
    base_url: "http://localhost:5173"
    tests:
      - name: "로그인 화면 검증"
        url: "/login"
        viewport: { width: 1920, height: 1080 }
        validations:
          - type: "screenshot"
            selector: "body"
            baseline: "screenshots/baseline/login.png"
          - type: "element"
            selector: "h1"
            expected_value: "로그인"
      - name: "대시보드 화면 검증"
        url: "/dashboard"
        validations:
          - type: "screenshot"
            selector: ".dashboard-container"
```

### Phase 2: 스크린샷 비교 엔진 (1주)

**목표**: 기준 스크린샷과 현재 스크린샷을 비교하여 차이점 감지

**작업 내용**:
1. Pillow를 사용한 이미지 비교 로직 구현
2. 픽셀 차이 분석 및 차이 영역 추출
3. 차이 임계값 설정 (5% 이상 변경 시 실패)
4. 차이 영역 하이라이트 이미지 생성

**예상 산출물**:
- `test-utils/screenshot_comparer.py`
- 차이 분석 알고리즘

**기능**:
- 픽셀 단위 비교
- 차이 비율 계산
- 차이 영역 시각화
- 변경사항 리포트 생성

### Phase 3: 배치 테스트 실행 엔진 (1주)

**목표**: 여러 테스트 케이스를 순차/병렬로 실행

**작업 내용**:
1. 테스트 실행 큐 관리
2. Playwright 브라우저 인스턴스 관리
3. 테스트 실행 로직 구현 (순차/병렬 선택)
4. 에러 핸들링 및 재시도 로직

**예상 산출물**:
- `test-utils/test_runner.py`
- 테스트 실행 엔진

**기능**:
- 테스트 케이스 순차 실행
- 병렬 실행 옵션 (선택사항)
- 타임아웃 처리
- 에러 발생 시 스크린샷 저장

### Phase 4: 리포트 생성 시스템 (1주)

**목표**: 테스트 결과를 마크다운/HTML 형식으로 자동 생성

**작업 내용**:
1. 리포트 템플릿 설계 (마크다운, HTML)
2. Jinja2 템플릿 엔진 연동
3. 테스트 결과 데이터 수집 및 가공
4. 리포트 파일 생성

**예상 산출물**:
- `test-utils/report_generator.py`
- 리포트 템플릿 파일들

**리포트 내용**:
- 테스트 실행 요약 (성공/실패 개수)
- 각 테스트 케이스별 상세 결과
- 스크린샷 비교 결과 (차이 이미지 포함)
- 실패한 테스트 케이스 목록
- 개선 제안

### Phase 5: MCP 서버 통합 (0.5주)

**목표**: 모든 기능을 MCP 서버로 통합

**작업 내용**:
1. MCP 서버에 새로운 도구 추가
   - `run_integration_tests`: 배치 테스트 실행
   - `compare_screenshots`: 스크린샷 비교
   - `generate_test_report`: 리포트 생성
2. 기존 화면 검증 기능과 통합
3. API 엔드포인트 추가 (선택사항)

**예상 산출물**:
- `mcp-integration-test-server.py` (업데이트)
- API 엔드포인트 (선택사항)

---

## 5. 구현 상세

### 5.1 테스트 케이스 YAML 스키마

```yaml
test_suites:
  - name: string              # 테스트 스위트 이름
    description: string       # 설명
    base_url: string          # 기본 URL
    timeout: number           # 타임아웃 (초)
    tests:
      - name: string          # 테스트 이름
        url: string           # 테스트할 URL (상대 경로 또는 절대 경로)
        viewport:             # 뷰포트 설정
          width: number
          height: number
        wait_time: number     # 페이지 로드 대기 시간 (밀리초)
        actions:              # 액션 목록 (선택사항)
          - type: "click"     # click, fill, select 등
            selector: string
            value: string     # fill의 경우
        validations:          # 검증 목록
          - type: "screenshot" | "element" | "text"
            selector: string
            expected_value: string  # element/text 타입의 경우
            baseline: string        # screenshot 타입의 경우
            threshold: number      # screenshot 차이 임계값 (%)
```

### 5.2 스크린샷 비교 알고리즘

```python
def compare_screenshots(baseline_path, current_path, threshold=5.0):
    """
    두 스크린샷을 비교하여 차이점을 분석
    
    Returns:
        dict: {
            'is_different': bool,
            'difference_percentage': float,
            'diff_image_path': str,
            'changed_regions': list
        }
    """
    # 1. 이미지 로드
    # 2. 크기 비교 (다르면 실패)
    # 3. 픽셀 단위 비교
    # 4. 차이 비율 계산
    # 5. 임계값 초과 시 차이 영역 추출
    # 6. 차이 이미지 생성
```

### 5.3 테스트 실행 플로우

```
1. 테스트 케이스 YAML 로드
2. 테스트 케이스 검증
3. 각 테스트 케이스에 대해:
   a. Playwright 브라우저 실행
   b. URL 접속
   c. 액션 수행 (있는 경우)
   d. 검증 수행:
      - 스크린샷: 캡처 → 비교
      - 요소: 값 읽기 → 비교
   e. 결과 저장
4. 리포트 생성
5. 브라우저 종료
```

### 5.4 MCP 도구 정의

```python
@server.list_tools()
async def list_tools() -> list[Tool]:
    return [
        Tool(
            name="run_integration_tests",
            description="테스트 케이스 파일을 읽어서 배치 테스트를 실행합니다.",
            inputSchema={
                "type": "object",
                "properties": {
                    "test_case_file": {
                        "type": "string",
                        "description": "테스트 케이스 YAML 파일 경로"
                    },
                    "parallel": {
                        "type": "boolean",
                        "description": "병렬 실행 여부 (기본값: false)"
                    }
                },
                "required": ["test_case_file"]
            }
        ),
        Tool(
            name="compare_screenshots",
            description="두 스크린샷을 비교하여 차이점을 분석합니다.",
            inputSchema={
                "type": "object",
                "properties": {
                    "baseline_path": {"type": "string"},
                    "current_path": {"type": "string"},
                    "threshold": {"type": "number", "default": 5.0}
                },
                "required": ["baseline_path", "current_path"]
            }
        ),
        Tool(
            name="generate_test_report",
            description="테스트 실행 결과를 기반으로 리포트를 생성합니다.",
            inputSchema={
                "type": "object",
                "properties": {
                    "test_results": {"type": "object"},
                    "output_format": {
                        "type": "string",
                        "enum": ["markdown", "html", "both"],
                        "default": "both"
                    }
                },
                "required": ["test_results"]
            }
        )
    ]
```

---

## 6. 예상 효과

### 6.1 시간 절감

| 작업 | 기존 소요 시간 | 개선 후 소요 시간 | 절감률 |
|------|------------|--------------|--------|
| 배포 전 화면 검증 (10개 화면) | 2-3시간 | 30분 | **85%** |
| 회귀 테스트 (스크린샷 비교) | 1-2시간 | 10분 | **90%** |
| 테스트 결과 리포트 작성 | 30분 | 자동 생성 | **100%** |

### 6.2 품질 향상

- **일관성**: 동일한 기준으로 모든 화면 검증
- **누락 방지**: 자동화로 모든 테스트 케이스 실행 보장
- **조기 발견**: 배포 전 UI 버그 사전 발견
- **문서화**: 테스트 결과가 자동으로 문서화됨

---

## 7. 의존성 설치

```bash
# Python 패키지
pip install mcp playwright pillow pyyaml jinja2

# Playwright 브라우저 설치
playwright install chromium

# 선택사항 (고급 이미지 비교)
pip install opencv-python numpy
```

---

## 8. 사용 예시

### 8.1 테스트 케이스 작성

```yaml
# tests/test-cases.yaml
test_suites:
  - name: "메인 화면 검증"
    base_url: "http://localhost:5173"
    tests:
      - name: "홈페이지 검증"
        url: "/"
        validations:
          - type: "screenshot"
            selector: "body"
            baseline: "screenshots/baseline/home.png"
            threshold: 5.0
      - name: "로그인 화면 검증"
        url: "/login"
        validations:
          - type: "element"
            selector: "h1"
            expected_value: "로그인"
```

### 8.2 MCP 서버를 통한 실행

```python
# Cursor AI에서 실행
run_integration_tests({
    "test_case_file": "tests/test-cases.yaml",
    "parallel": false
})
```

### 8.3 결과 확인

- `test-results/reports/test-report-YYYYMMDD-HHMMSS.md`
- `test-results/reports/test-report-YYYYMMDD-HHMMSS.html`
- `test-results/screenshots/` (실행 스크린샷)

---

## 9. 향후 확장 계획

### 9.1 단기 (추가 0.3 MM)

- CI/CD 파이프라인 통합 (GitHub Actions 등)
- Slack/이메일 알림 기능
- 테스트 결과 대시보드

### 9.2 중기 (추가 0.5 MM)

- 성능 테스트 통합 (페이지 로드 시간 측정)
- 접근성 테스트 통합 (WCAG 준수 검증)
- 크로스 브라우저 테스트 (Chrome, Firefox, Safari)

---

## 10. 리스크 및 대응 방안

| 리스크 | 영향도 | 대응 방안 |
|--------|--------|----------|
| 동적 콘텐츠로 인한 스크린샷 불일치 | 중 | 타임스탬프/랜덤 값 제외 설정, 특정 영역만 비교 |
| 테스트 실행 시간 증가 | 낮 | 병렬 실행 옵션 제공, 불필요한 테스트 제외 |
| 브라우저 리소스 부족 | 낮 | 브라우저 인스턴스 풀 관리, 메모리 최적화 |

---

**문서 버전**: 1.0  
**최종 수정일**: 2025년 1월

